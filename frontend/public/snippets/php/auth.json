{
  "id": "php-auth",
  "name": "Authentification PHP",
  "description": "Système d'authentification avec sessions et hash de mots de passe",
  "language": "php",
  "feature": "auth",
  "code": "<?php\n\nclass Auth {\n    private $db;\n    \n    public function __construct($db) {\n        $this->db = $db;\n        $this->startSession();\n    }\n    \n    private function startSession() {\n        if (session_status() === PHP_SESSION_NONE) {\n            session_start();\n        }\n    }\n    \n    public function register($email, $password, $name) {\n        // Validation\n        if (empty($email) || empty($password) || empty($name)) {\n            throw new Exception('All fields are required');\n        }\n        \n        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {\n            throw new Exception('Invalid email format');\n        }\n        \n        if (strlen($password) < 8) {\n            throw new Exception('Password must be at least 8 characters');\n        }\n        \n        // Vérifier si l'email existe déjà\n        $stmt = $this->db->prepare('SELECT id FROM users WHERE email = ?');\n        $stmt->execute([$email]);\n        if ($stmt->fetch()) {\n            throw new Exception('Email already exists');\n        }\n        \n        // Hasher le mot de passe\n        $hashedPassword = password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);\n        \n        // Créer l'utilisateur\n        $stmt = $this->db->prepare('INSERT INTO users (email, password, name, created_at) VALUES (?, ?, ?, NOW())');\n        $stmt->execute([$email, $hashedPassword, $name]);\n        \n        return $this->db->lastInsertId();\n    }\n    \n    public function login($email, $password) {\n        // Récupérer l'utilisateur\n        $stmt = $this->db->prepare('SELECT id, email, password, name FROM users WHERE email = ?');\n        $stmt->execute([$email]);\n        $user = $stmt->fetch(PDO::FETCH_ASSOC);\n        \n        if (!$user) {\n            throw new Exception('Invalid credentials');\n        }\n        \n        // Vérifier le mot de passe\n        if (!password_verify($password, $user['password'])) {\n            throw new Exception('Invalid credentials');\n        }\n        \n        // Créer la session\n        $_SESSION['user_id'] = $user['id'];\n        $_SESSION['user_email'] = $user['email'];\n        $_SESSION['user_name'] = $user['name'];\n        \n        // Régénérer l'ID de session pour prévenir le fixation attack\n        session_regenerate_id(true);\n        \n        return $user;\n    }\n    \n    public function logout() {\n        $_SESSION = [];\n        \n        if (isset($_COOKIE[session_name()])) {\n            setcookie(session_name(), '', time() - 3600, '/');\n        }\n        \n        session_destroy();\n    }\n    \n    public function isLoggedIn() {\n        return isset($_SESSION['user_id']);\n    }\n    \n    public function getUserId() {\n        return $_SESSION['user_id'] ?? null;\n    }\n    \n    public function getUser() {\n        if (!$this->isLoggedIn()) {\n            return null;\n        }\n        \n        $stmt = $this->db->prepare('SELECT id, email, name, created_at FROM users WHERE id = ?');\n        $stmt->execute([$_SESSION['user_id']]);\n        return $stmt->fetch(PDO::FETCH_ASSOC);\n    }\n    \n    public function requireAuth() {\n        if (!$this->isLoggedIn()) {\n            http_response_code(401);\n            echo json_encode(['error' => 'Authentication required']);\n            exit;\n        }\n    }\n    \n    public function changePassword($userId, $oldPassword, $newPassword) {\n        if (strlen($newPassword) < 8) {\n            throw new Exception('New password must be at least 8 characters');\n        }\n        \n        $stmt = $this->db->prepare('SELECT password FROM users WHERE id = ?');\n        $stmt->execute([$userId]);\n        $user = $stmt->fetch(PDO::FETCH_ASSOC);\n        \n        if (!password_verify($oldPassword, $user['password'])) {\n            throw new Exception('Current password is incorrect');\n        }\n        \n        $hashedPassword = password_hash($newPassword, PASSWORD_BCRYPT, ['cost' => 12]);\n        \n        $stmt = $this->db->prepare('UPDATE users SET password = ? WHERE id = ?');\n        $stmt->execute([$hashedPassword, $userId]);\n    }\n    \n    public function resetPassword($email, $token, $newPassword) {\n        // Vérifier le token (à implémenter avec une table password_resets)\n        $stmt = $this->db->prepare('SELECT * FROM password_resets WHERE email = ? AND token = ? AND expires_at > NOW()');\n        $stmt->execute([$email, $token]);\n        $reset = $stmt->fetch(PDO::FETCH_ASSOC);\n        \n        if (!$reset) {\n            throw new Exception('Invalid or expired token');\n        }\n        \n        $hashedPassword = password_hash($newPassword, PASSWORD_BCRYPT, ['cost' => 12]);\n        \n        $this->db->beginTransaction();\n        try {\n            $stmt = $this->db->prepare('UPDATE users SET password = ? WHERE email = ?');\n            $stmt->execute([$hashedPassword, $email]);\n            \n            $stmt = $this->db->prepare('DELETE FROM password_resets WHERE email = ?');\n            $stmt->execute([$email]);\n            \n            $this->db->commit();\n        } catch (Exception $e) {\n            $this->db->rollBack();\n            throw $e;\n        }\n    }\n}\n\n// Utilisation\n$auth = new Auth($pdo);\n\ntry {\n    // Inscription\n    $userId = $auth->register('user@example.com', 'password123', 'John Doe');\n    \n    // Connexion\n    $user = $auth->login('user@example.com', 'password123');\n    \n    // Vérifier si connecté\n    if ($auth->isLoggedIn()) {\n        $currentUser = $auth->getUser();\n        echo json_encode($currentUser);\n    }\n    \n    // Déconnexion\n    // $auth->logout();\n    \n} catch (Exception $e) {\n    echo json_encode(['error' => $e->getMessage()]);\n}",
  "variables": [
    {
      "name": "authFeatures",
      "type": "multiselect",
      "label": "Fonctionnalités d'authentification",
      "required": true,
      "description": "Sélectionnez les fonctionnalités à inclure",
      "defaultValue": ["register", "login", "logout"],
      "options": [
        { "value": "register", "label": "Inscription" },
        { "value": "login", "label": "Connexion" },
        { "value": "logout", "label": "Déconnexion" },
        { "value": "changePassword", "label": "Changement de mot de passe" },
        { "value": "resetPassword", "label": "Réinitialisation de mot de passe" }
      ]
    },
    {
      "name": "minPasswordLength",
      "type": "number",
      "label": "Longueur minimale du mot de passe",
      "required": false,
      "description": "Longueur minimale requise pour le mot de passe",
      "defaultValue": 8,
      "min": 6,
      "max": 20
    },
    {
      "name": "passwordCost",
      "type": "select",
      "label": "Coût du hash (BCRYPT)",
      "required": false,
      "description": "Coût du hashage (plus élevé = plus sécurisé mais plus lent)",
      "defaultValue": "12",
      "options": [
        { "value": "10", "label": "10 (rapide)" },
        { "value": "12", "label": "12 (recommandé)" },
        { "value": "14", "label": "14 (sécurisé)" }
      ]
    },
    {
      "name": "includeSessionRegeneration",
      "type": "checkbox",
      "label": "Régénération d'ID de session",
      "required": false,
      "description": "Régénérer l'ID de session après connexion (prévention fixation attack)",
      "defaultValue": true
    }
  ],
  "security": {
    "sqlInjection": true,
    "xss": false,
    "csrf": true
  }
}

