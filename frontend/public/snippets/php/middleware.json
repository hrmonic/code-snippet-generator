{
  "id": "php-middleware",
  "name": "Middleware PHP",
  "description": "Système de middleware pour authentification et validation",
  "language": "php",
  "feature": "middleware",
  "code": "<?php\n\ninterface Middleware {\n    public function handle($request, $next);\n}\n\nclass MiddlewareStack {\n    private $middlewares = [];\n    \n    public function add(Middleware $middleware) {\n        $this->middlewares[] = $middleware;\n        return $this;\n    }\n    \n    public function run($request) {\n        $index = 0;\n        \n        $next = function($request) use (&$index, &$next) {\n            if ($index >= count($this->middlewares)) {\n                return $request;\n            }\n            \n            $middleware = $this->middlewares[$index++];\n            return $middleware->handle($request, $next);\n        };\n        \n        return $next($request);\n    }\n}\n\n// Middleware d'authentification\nclass AuthMiddleware implements Middleware {\n    public function handle($request, $next) {\n        if (!isset($_SESSION['user_id'])) {\n            http_response_code(401);\n            echo json_encode(['error' => 'Unauthorized']);\n            exit;\n        }\n        \n        $request['user'] = $_SESSION['user'];\n        return $next($request);\n    }\n}\n\n// Middleware de validation CSRF\nclass CsrfMiddleware implements Middleware {\n    public function handle($request, $next) {\n        if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n            $token = $_POST['csrf_token'] ?? $_SERVER['HTTP_X_CSRF_TOKEN'] ?? null;\n            \n            if (!$token || $token !== $_SESSION['csrf_token']) {\n                http_response_code(403);\n                echo json_encode(['error' => 'Invalid CSRF token']);\n                exit;\n            }\n        }\n        \n        return $next($request);\n    }\n}\n\n// Middleware de validation\nclass ValidationMiddleware implements Middleware {\n    private $rules;\n    \n    public function __construct($rules) {\n        $this->rules = $rules;\n    }\n    \n    public function handle($request, $next) {\n        $data = $request['data'] ?? [];\n        $errors = [];\n        \n        foreach ($this->rules as $field => $ruleString) {\n            $rules = explode('|', $ruleString);\n            $value = $data[$field] ?? null;\n            \n            foreach ($rules as $rule) {\n                if ($rule === 'required' && empty($value)) {\n                    $errors[$field][] = \"The {$field} field is required\";\n                } elseif ($rule === 'email' && !filter_var($value, FILTER_VALIDATE_EMAIL)) {\n                    $errors[$field][] = \"The {$field} must be a valid email\";\n                }\n            }\n        }\n        \n        if (!empty($errors)) {\n            http_response_code(422);\n            echo json_encode(['errors' => $errors]);\n            exit;\n        }\n        \n        return $next($request);\n    }\n}\n\n// Middleware de logging\nclass LoggingMiddleware implements Middleware {\n    public function handle($request, $next) {\n        $startTime = microtime(true);\n        \n        $response = $next($request);\n        \n        $duration = microtime(true) - $startTime;\n        error_log(sprintf(\n            '%s %s - %s - %.3fs',\n            $_SERVER['REQUEST_METHOD'],\n            $_SERVER['REQUEST_URI'],\n            http_response_code(),\n            $duration\n        ));\n        \n        return $response;\n    }\n}\n\n// Middleware CORS\nclass CorsMiddleware implements Middleware {\n    private $allowedOrigins;\n    \n    public function __construct($allowedOrigins = ['*']) {\n        $this->allowedOrigins = $allowedOrigins;\n    }\n    \n    public function handle($request, $next) {\n        $origin = $_SERVER['HTTP_ORIGIN'] ?? '*';\n        \n        if (in_array('*', $this->allowedOrigins) || in_array($origin, $this->allowedOrigins)) {\n            header(\"Access-Control-Allow-Origin: {$origin}\");\n        }\n        \n        header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');\n        header('Access-Control-Allow-Headers: Content-Type, Authorization, X-CSRF-Token');\n        header('Access-Control-Allow-Credentials: true');\n        \n        if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\n            http_response_code(200);\n            exit;\n        }\n        \n        return $next($request);\n    }\n}\n\n// Utilisation\n$stack = new MiddlewareStack();\n\n$stack\n    ->add(new CorsMiddleware(['http://localhost:3000']))\n    ->add(new LoggingMiddleware())\n    ->add(new CsrfMiddleware())\n    ->add(new ValidationMiddleware([\n        'email' => 'required|email',\n        'password' => 'required|min:8'\n    ]))\n    ->add(new AuthMiddleware());\n\n$request = [\n    'data' => $_POST,\n    'method' => $_SERVER['REQUEST_METHOD'],\n    'uri' => $_SERVER['REQUEST_URI']\n];\n\n$response = $stack->run($request);",
  "variables": [
    {
      "name": "middlewareTypes",
      "type": "multiselect",
      "label": "Types de middlewares",
      "required": true,
      "description": "Sélectionnez les middlewares à inclure",
      "defaultValue": ["auth", "cors", "validation"],
      "options": [
        { "value": "auth", "label": "Authentification" },
        { "value": "cors", "label": "CORS" },
        { "value": "validation", "label": "Validation" },
        { "value": "csrf", "label": "CSRF Protection" },
        { "value": "logging", "label": "Logging" }
      ]
    },
    {
      "name": "corsOrigins",
      "type": "text",
      "label": "Origines CORS autorisées",
      "required": false,
      "description": "Origines séparées par des virgules (laissez vide pour *)",
      "placeholder": "http://localhost:3000,https://example.com",
      "dependsOn": {
        "middlewareTypes": ["cors"]
      }
    }
  ],
  "security": {
    "sqlInjection": false,
    "xss": true,
    "csrf": true
  }
}

